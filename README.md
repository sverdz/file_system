# 📦 File Inventory Tool - Інструмент інвентаризації та перейменування файлів

> Повнофункціональна TUI (Text User Interface) система для автоматизованої інвентаризації, класифікації, перейменування та організації файлів з підтримкою LLM (Claude/ChatGPT), OCR, дедуплікації та інтелектуальною фільтрацією.

[![Python 3.11+](https://img.shields.io/badge/python-3.11+-blue.svg)](https://www.python.org/downloads/)
[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)

---

## 📋 Зміст

- [Ключові можливості](#-ключові-можливості)
- [Візуальний інтерфейс](#-візуальний-інтерфейс)
- [Архітектура системи](#-архітектура-системи)
- [Встановлення](#-встановлення)
- [Швидкий старт](#-швидкий-старт)
- [Детальне використання](#-детальне-використання)
- [Логіка перейменування](#-логіка-перейменування)
- [Фільтрація файлів](#-фільтрація-файлів)
- [Робота з дублікатами](#-робота-з-дублікатами)
- [LLM інтеграція](#-llm-інтеграція)
- [Конфігурація](#-конфігурація)
- [Структура проекту](#-структура-проекту)
- [Формат Excel інвентаризації](#-формат-excel-інвентаризації)
- [Troubleshooting](#-troubleshooting)
- [FAQ](#-faq)

---

## 🚀 Ключові можливості

### 🎯 Основний функціонал

#### 1. **Інтелектуальна інвентаризація файлів**
- 📊 Сканування великих обсягів файлів (десятки тисяч)
- 🔍 Автоматична класифікація документів (договір, рахунок, акт, протокол, лист, наказ, звіт та інші)
- 📝 Вилучення тексту з PDF, DOCX, зображень через OCR (Tesseract)
- 🔐 Обчислення SHA-256 хешів для виявлення дублікатів
- 📈 Експорт детальної інвентаризації у багатолистовий Excel файл

#### 2. **Жорстке обмеження довжини імен (20 символів)**
- ✂️ Автоматичне формування імен за шаблоном: `{ДАТА}_{КАТЕГОРІЯ}_{СУФІКС}.ext`
- 🎯 Гарантовано коректні імена для всіх файлових систем
- 🔄 Автоматичне усічення класифікації при перевищенні ліміту
- 🔤 Короткі унікальні суфікси: `a`, `b`, `c`... `z`, потім `1`, `2`, `3`...
- ⚠️ Попередження про колізії імен

#### 3. **Інтелектуальна фільтрація службових файлів** ⭐ НОВЕ
- 🚫 Автоматичне виключення службових папок:
  - `.git`, `node_modules`, `venv`, `__pycache__`
  - `.idea`, `.vscode`, `dist`, `build`, `target`
  - `duplicates`, `runs` (власні робочі папки)
- 📄 Виключення системних файлів:
  - `.DS_Store`, `Thumbs.db`, `*.pyc`, `*.dll`, `*.exe`
  - `*.log`, `*.tmp`, `*.cache`
  - Lock-файли: `package-lock.json`, `yarn.lock`, `Pipfile.lock`
- ✅ Включення тільки потрібних розширень:
  - Документи: `.pdf`, `.docx`, `.xlsx`, `.txt`
  - Зображення: `.jpg`, `.png`, `.gif`, `.svg`
  - Архіви: `.zip`, `.rar`, `.7z`
- 📋 Службові файли відображаються в Excel, але не обробляються

#### 4. **Візуальний прогрес-трекер** ⭐ ПОКРАЩЕНО
- 📊 Лінійний прогрес-бар 0-100% (від кількості оброблених файлів)
- ⏱️ Незалежний таймер (оновлюється кожну секунду)
- 📈 Реальний час обробки кожного файлу
- 📐 Симетричні панелі (95% ширини терміналу)
- 🎨 Українізований інтерфейс
- 🔄 Оновлення після кожного файлу (не тільки кожні 10)

#### 5. **Виявлення та обробка дублікатів**
- 🔍 Точні дублікати (SHA256)
- 📊 Групування дублікатів за хешем
- 🗂️ Переміщення дублікатів у папку `duplicates/`
- 🗑️ Видалення дублікатів в кошик (безпечно)
- 📋 Детальний звіт про дублікати

#### 6. **LLM інтеграція (опціонально)**
- 🤖 Підтримка Claude (Anthropic) та ChatGPT (OpenAI)
- 📝 Автоматична анотація та класифікація документів
- 🎯 Інтерактивні запити до LLM для конкретних файлів
- 📊 Відстеження токенів та статистики використання
- 💰 Контроль витрат (підрахунок вартості запитів)

#### 7. **Організація та сортування**
- 📁 Автоматичне сортування:
  - По категоріях (договори, рахунки, акти тощо)
  - По датах (рік/місяць/день)
  - По типах файлів (.pdf, .docx, .jpg тощо)
- 🔄 Об'єднання файлів з підпапок
- 📋 Збереження повної історії операцій

#### 8. **Обробка помилок** ⭐ ПОКРАЩЕНО
- ✅ Не переривати виконання при помилках окремих файлів
- 📝 Збирати всі помилки в список
- 📊 Детальний звіт про помилки в кінці обробки
- 🔄 Продовження обробки навіть якщо деякі файли недоступні

---

## 🖥️ Візуальний інтерфейс

### Головне меню

```
File Inventory Tool
[1] Швидкий аналіз (dry-run)
[2] Застосувати перейменування (commit)
[3] Переглянути підсумок останнього запуску
[4] Налаштування
[5] Відновити незавершений запуск
[6] Сортування та подання
[7] Робота з дублікатами
[0] Вихід
```

### Прогрес-бар під час обробки ⭐ НОВИЙ ВИГЛЯД

```
╭──────────────────────────────────────── ЗАГАЛЬНИЙ ПРОГРЕС ────────────────────────────────────────╮
│ ████████████████░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░ 15.5% (155/1000 файлів)                       │
╰────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────── СТАТУС ──────────────────────────────────────────────╮
│ 15.5% (155/1000) │ ⏱️ 00:05:23 │ ✅ 150 │ ⚠️ 10 │ ❌ 0                                            │
╰────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭──────────────────────────────────────── ⚙️  ПОТОЧНИЙ ФАЙЛ ────────────────────────────────────────╮
│ [⚙️][08:15:30][0x7FA9] Договір_постачання_2024.pdf                                                │
│ ├─ 📏 2.3 MB │ 📅 15.09.2024 10:30 │ 🔒 SHA-256: a1b2c3d4...                                       │
│ ├─ 📝 Вилучення тексту   ████████████░░░░░░░   65%                                                │
╰────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭─────────────────────────────────────── 📈 СТАТИСТИКА СЕСІЇ ───────────────────────────────────────╮
│ ✅ Completed: 150 │ ⚠️  Duplicates: 10 │ ❌ Errors: 0 │ ⏳ Pending: 845                            │
╰────────────────────────────────────────────────────────────────────────────────────────────────────╯
```

**Особливості візуалу:**
- ✅ Всі панелі однакової ширини (95% терміналу) для симетрії
- ⏱️ Таймер оновлюється кожну секунду незалежно від обробки файлів
- 📊 Прогрес-бар лінійний: від 0% до 100% відповідно до кількості файлів
- 🎨 Українські назви всіх панелей
- 📈 Реальний час відображення поточного файлу

### Меню роботи з дублікатами

```
╭─────────────────────── РОБОТА З ДУБЛІКАТАМИ ───────────────────────╮
│ [1] Показати список дублікатів                                     │
│ [2] Перемістити всі дублікати в папку 'duplicates'                │
│ [3] Видалити всі дублікати (в кошик)                              │
│ [4] Повернутися до головного меню                                  │
╰────────────────────────────────────────────────────────────────────╯
```

### Звіт про помилки (в кінці обробки) ⭐ НОВЕ

```
╭──────────────────────────────────── ❌ Помилки обробки (3 файлів) ─────────────────────────────────╮
│ ┌────────────┬──────────────────────────────────────────────┬──────────────────────────────────┐ │
│ │ Час        │ Файл                                         │ Помилка                          │ │
│ ├────────────┼──────────────────────────────────────────────┼──────────────────────────────────┤ │
│ │ 08:15:42   │ corrupted_file.pdf                           │ Пошкоджений PDF: EOF marker      │ │
│ │ 08:16:10   │ protected.docx                               │ Файл захищений паролем           │ │
│ │ 08:17:05   │ network_file.xlsx                            │ Помилка читання: Permission      │ │
│ └────────────┴──────────────────────────────────────────────┴──────────────────────────────────┘ │
╰────────────────────────────────────────────────────────────────────────────────────────────────────╯
```

---

## 🏗️ Архітектура системи

```
file_system/
├── app/                          # Основний код програми
│   ├── classify.py               # Класифікація документів (LLM + heuristics)
│   ├── config.py                 # Конфігурація та параметри
│   ├── dedup.py                  # Виявлення дублікатів (exact/near)
│   ├── extract.py                # Вилучення тексту (PDF, DOCX, OCR)
│   ├── hacker_ui.py              # Компоненти візуального інтерфейсу
│   ├── inventory.py              # Експорт інвентаризації в Excel
│   ├── llm_client.py             # Клієнт для Claude/ChatGPT
│   ├── main.py                   # Головний TUI інтерфейс + меню
│   ├── progress.py               # ⭐ Прогрес-бар, таймер, трекінг етапів
│   ├── rename.py                 # Логіка перейменування файлів
│   ├── scan.py                   # ⭐ Сканування + фільтрація файлів
│   ├── sortout.py                # Сортування та організація файлів
│   └── theme.py                  # Кольорова схема інтерфейсу
│
├── runs/                         # Історія всіх сесій обробки
│   └── run_YYYYMMDD_HHMMSS/      # Окрема папка для кожної сесії
│       ├── config.yaml           # Знімок конфігурації сесії
│       ├── inventory.xlsx        # ⭐ Детальна інвентаризація (58 полів)
│       └── progress.json         # Прогрес виконання
│
├── config.yaml                   # Глобальна конфігурація (в корені проекту)
├── requirements.txt              # Залежності Python
├── run.bat                       # Запуск для Windows
└── README.md                     # Ця документація
```

---

## 📥 Встановлення

### Вимоги

- Python 3.11 або новіше
- Tesseract OCR (опціонально, для OCR зображень)
- Windows/Linux/MacOS

### Крок 1: Клонування репозиторію

```bash
git clone https://github.com/yourusername/file_system.git
cd file_system
```

### Крок 2: Встановлення залежностей

```bash
pip install -r requirements.txt
```

**Основні залежності:**
- `pydantic` - валідація конфігурації
- `rich` - візуальний інтерфейс
- `pandas`, `openpyxl` - експорт в Excel
- `python-docx` - читання DOCX
- `pdfminer.six` - читання PDF
- `pillow`, `pytesseract` - OCR зображень
- `pyyaml` - конфігурація
- `send2trash` - безпечне видалення

### Крок 3: (Опціонально) Встановлення Tesseract для OCR

#### Windows:
```bash
# Завантажити з https://github.com/UB-Mannheim/tesseract/wiki
# Встановити та додати до PATH
```

#### Ubuntu/Debian:
```bash
sudo apt-get install tesseract-ocr tesseract-ocr-ukr tesseract-ocr-eng
```

#### MacOS:
```bash
brew install tesseract tesseract-lang
```

---

## ⚡ Швидкий старт

### Запуск програми

**Windows:**
```bash
run.bat
```

**Linux/MacOS:**
```bash
python -m app.main
```

### Базовий сценарій використання

1. **Запустити програму** → Вибрати `[1] Швидкий аналіз (dry-run)`

2. **Вказати папку** для сканування (або залишити поточну)

3. **Дочекатись завершення** - програма:
   - Просканує всі файли
   - Відфільтрує службові файли
   - Обчислить хеші
   - Витягне текст
   - Класифікує документи
   - Згенерує Excel звіт

4. **Переглянути результат** у папці `runs/run_YYYYMMDD_HHMMSS/inventory.xlsx`

5. **Застосувати зміни** → Вибрати `[2] Застосувати перейменування (commit)`

---

## 📖 Детальне використання

### 1. Швидкий аналіз (Dry-Run)

**Призначення:** Проаналізувати файли БЕЗ фактичного перейменування

```
Головне меню → [1] Швидкий аналіз (dry-run)
```

**Що відбувається:**
1. 📂 Сканування папки (з фільтрацією службових файлів)
2. 🔍 Виявлення дублікатів
3. 📝 Вилучення тексту з документів
4. 🎯 Класифікація (категорії, дати)
5. 📊 Генерація Excel інвентаризації
6. ✅ Файли НЕ перейменовуються

**Результат:**
- `runs/run_YYYYMMDD_HHMMSS/inventory.xlsx` - детальна інвентаризація
- `runs/run_YYYYMMDD_HHMMSS/progress.json` - статистика обробки

### 2. Застосування перейменування (Commit)

**Призначення:** Фактично перейменувати файли відповідно до класифікації

```
Головне меню → [2] Застосувати перейменування (commit)
```

**Попередження:** ⚠️ Це НЕОБОРОТНА операція! Файли будуть фактично перейменовані.

**Що відбувається:**
1. Виконується повний аналіз (як у dry-run)
2. Генерується план перейменування
3. 📋 Показується попередній перегляд (перші 50 файлів)
4. ❓ Запит підтвердження
5. ✅ Фактичне перейменування файлів

**Приклад попереднього перегляду:**

```
╭────────────────────────────── ПОПЕРЕДНІЙ ПЕРЕГЛЯД ПЕРЕЙМЕНУВАННЯ ──────────────────────────────╮
│ ┌──────────────────────────────────────┬──────────────────────────┬────────┬──────────────────┐ │
│ │ Старе ім'я                           │ Нове ім'я                │ Довжина│ Статус           │ │
│ ├──────────────────────────────────────┼──────────────────────────┼────────┼──────────────────┤ │
│ │ Договір постачання 2024.pdf          │ 20240915_dogovir_a.pdf   │ 18     │ ✓ OK             │ │
│ │ Рахунок №123 від 10.09.2024.xlsx     │ 20240910_rahunok_a.xlsx  │ 19     │ ✓ OK             │ │
│ │ Акт виконаних робіт.docx             │ 20241001_akt_a.docx      │ 15     │ ✓ OK             │ │
│ └──────────────────────────────────────┴──────────────────────────┴────────┴──────────────────┘ │
╰─────────────────────────────────────────────────────────────────────────────────────────────────╯

Показано перші 50 файлів з 1000. Переглянути всі можна в inventory.xlsx

Застосувати зміни? [y/N]:
```

### 3. Налаштування

```
Головне меню → [4] Налаштування
```

**Доступні налаштування:**

#### 3.1. Папка для аналізу
```
1. Папка для аналізу: C:/Documents
   Вкажіть новий шлях (Enter щоб лишити): D:/MyFiles
```

#### 3.2. Мова OCR
```
2. Мова OCR: ukr+eng
   Вкажіть мову (ukr+eng/eng/off, Enter щоб лишити): ukr+eng
```

#### 3.3. LLM налаштування
```
3. LLM налаштування:
   Поточний провайдер: none
   LLM увімкнено: False

   Налаштувати LLM? [y/N]: y

   Оберіть LLM провайдера:
   1 = Claude (Anthropic)
   2 = ChatGPT (OpenAI)
   3 = Вимкнути LLM

   Ваш вібір [1-3]: 1

   Введіть API ключ Claude: sk-ant-...

   Рекомендовані моделі:
   - claude-3-5-haiku-20241022 (швидка, дешева)
   - claude-3-5-sonnet-20241022 (найкраща для більшості)
   - claude-3-opus-20240229 (найпотужніша)

   Модель (Enter для claude-3-5-haiku-20241022): claude-3-5-sonnet-20241022

   ✓ Перевірка підключення...
   ✓ З'єднання успішне!
```

**Налаштування зберігаються** у файлі `config.yaml` в корені проекту.

### 4. Робота з дублікатами

```
Головне меню → [7] Робота з дублікатами
```

#### 4.1. Показати список дублікатів

```
╭───────────────────────────────── ГРУПИ ДУБЛІКАТІВ ─────────────────────────────────╮
│                                                                                     │
│ Група #1 (3 файли, SHA-256: a1b2c3d4...):                                         │
│   1. C:/Documents/file1.pdf (2.3 MB, 2024-09-15)                                  │
│   2. C:/Documents/backup/file1.pdf (2.3 MB, 2024-09-15)                           │
│   3. D:/Archive/old_file.pdf (2.3 MB, 2024-09-15)                                 │
│                                                                                     │
│ Група #2 (2 файли, SHA-256: e5f6g7h8...):                                         │
│   1. C:/Documents/report.xlsx (512 KB, 2024-10-01)                                │
│   2. C:/Documents/Копія report.xlsx (512 KB, 2024-10-01)                          │
│                                                                                     │
╰─────────────────────────────────────────────────────────────────────────────────────╯

Всього: 2 групи дублікатів, 3 дублікати (залишиться 2 мастер-файли)
```

#### 4.2. Перемістити дублікати

Дублікати переміщуються в папку `duplicates/` **в корені сканованої папки**:

```
C:/Documents/
├── file1.pdf               ← Мастер (залишається)
├── report.xlsx             ← Мастер (залишається)
└── duplicates/             ← Створюється автоматично
    ├── file1_dup1.pdf      ← Дублікат з backup/
    ├── old_file.pdf        ← Дублікат з Archive/
    └── Копія report.xlsx   ← Дублікат
```

#### 4.3. Видалити дублікати

Дублікати видаляються в **кошик** (безпечно, можна відновити):
- Windows: Recycle Bin
- MacOS: Trash
- Linux: Trash

### 5. Сортування та організація

```
Головне меню → [6] Сортування та подання
```

#### 5.1. Сортування за категоріями

```
_sorted/
├── by_category/
│   ├── договір/
│   │   ├── 20240915_dogovir_a.pdf
│   │   └── 20240920_dogovir_b.pdf
│   ├── рахунок/
│   │   ├── 20240910_rahunok_a.xlsx
│   │   └── 20240925_rahunok_b.xlsx
│   └── акт/
│       └── 20241001_akt_a.docx
```

#### 5.2. Сортування за датами

```
_sorted/
├── by_date/
│   ├── 2024/
│   │   ├── 09_вересень/
│   │   │   ├── 15/
│   │   │   │   └── 20240915_dogovir_a.pdf
│   │   │   ├── 20/
│   │   │   │   └── 20240920_dogovir_b.pdf
│   │   │   └── 25/
│   │   │       └── 20240925_rahunok_b.xlsx
│   │   └── 10_жовтень/
│   │       └── 01/
│   │           └── 20241001_akt_a.docx
```

#### 5.3. Сортування за типами

```
_sorted/
├── by_type/
│   ├── pdf/
│   │   ├── 20240915_dogovir_a.pdf
│   │   └── 20240920_dogovir_b.pdf
│   ├── xlsx/
│   │   ├── 20240910_rahunok_a.xlsx
│   │   └── 20240925_rahunok_b.xlsx
│   └── docx/
│       └── 20241001_akt_a.docx
```

---

## ⚙️ Логіка перейменування

### Шаблон імені файлу

```
{ДАТА}_{КАТЕГОРІЯ}_{СУФІКС}.ext
│      │           │        │
│      │           │        └─ Оригінальне розширення (.pdf, .docx, ...)
│      │           └────────── Унікальний суфікс (a-z, потім 1-99)
│      └────────────────────── Скорочена категорія (автоматично усічена)
└───────────────────────────── Дата (YYYYMMDD або YYMMDD)
```

### Приклади

#### Приклад 1: Звичайний файл
```
Вхід:  "Договір постачання товарів від 15.09.2024.pdf"
Вихід: "20240915_dogovir_a.pdf"
       │        │        │  │
       │        │        │  └─ Розширення
       │        │        └──── Суфікс (перший файл в цей день)
       │        └───────────── Скорочена категорія "договір" → "dogovir"
       └────────────────────── Дата з файлу: 15.09.2024
```

#### Приклад 2: Дублікат в той же день
```
Вхід:  "Інший договір від 15.09.2024.pdf"
Вихід: "20240915_dogovir_b.pdf"
                          └──── Наступний суфікс (b)
```

#### Приклад 3: Довга назва категорії
```
Вхід:  "Специфікація технічна детальна 2024.docx"
Вихід: "20241015_specifikaci_a.docx"
                └───────────────────── Усічено до 12 символів + суфікс
```

### Обмеження довжини

**Максимальна довжина:** 20 символів (без розширення)

**Формула розрахунку:**
```
Дата: 8 символів (YYYYMMDD)
Підкреслення: 1 символ
Категорія: від 1 до 10 символів (автоматично усікається)
Підкреслення: 1 символ
Суфікс: 1 символ
──────────────────────────
Всього: від 12 до 20 символів
```

**Приклади усічення:**
```
"договір_постачання" → "dogovir_po"  (10 символів)
"рахунок"           → "rahunok"      (7 символів)
"акт"               → "akt"          (3 символи)
"специфікація"      → "specifikac"   (10 символів)
```

### Унікальні суфікси

Суфікси генеруються в наступному порядку:

```
1-й файл: a
2-й файл: b
3-й файл: c
...
26-й файл: z
27-й файл: 1
28-й файл: 2
...
126-й файл: 99
```

**Приклад для 5 файлів в один день:**
```
20240915_dogovir_a.pdf
20240915_dogovir_b.pdf
20240915_dogovir_c.pdf
20240915_dogovir_d.pdf
20240915_dogovir_e.pdf
```

---

## 🔍 Фільтрація файлів

### Виключені папки

Програма автоматично ігнорує наступні папки:

#### Системи контролю версій
- `.git`, `.svn`, `.hg`

#### Залежності
- `node_modules` (JavaScript)
- `vendor` (PHP)

#### Python
- `venv`, `.venv`, `env`, `virtualenv`
- `__pycache__`, `.pytest_cache`

#### IDE
- `.idea` (IntelliJ IDEA, PyCharm)
- `.vscode` (Visual Studio Code)
- `.vs` (Visual Studio)

#### Збірка
- `dist`, `build`, `target`, `out`, `bin`, `obj`

#### Службові папки програми
- `duplicates` - папка з дублікатами
- `_sorted`, `_output` - відсортовані файли
- `_near_duplicates` - схожі файли
- `runs` - історія запусків

### Виключені файли

#### Системні файли
- `.DS_Store` (MacOS)
- `Thumbs.db`, `desktop.ini` (Windows)

#### Python
- `*.pyc`, `*.pyo`, `*.pyd` - скомпільовані файли

#### Бібліотеки
- `*.dll`, `*.so`, `*.dylib` - системні бібліотеки

#### Виконувані файли
- `*.exe`, `*.bin`, `*.app`

#### Тимчасові файли
- `*.log`, `*.tmp`, `*.temp`, `*.cache`

#### Git конфігурація
- `.gitignore`, `.gitattributes`, `.editorconfig`

#### Lock файли
- `package-lock.json` (npm)
- `yarn.lock` (Yarn)
- `composer.lock` (Composer)
- `Pipfile.lock` (Pipenv)

#### Мінімізовані файли
- `*.min.js`, `*.min.css`

### Включені розширення

Програма обробляє **тільки** наступні типи файлів:

#### Документи
- `.pdf`, `.doc`, `.docx`, `.odt`
- `.xls`, `.xlsx`, `.ods`, `.csv`
- `.ppt`, `.pptx`, `.odp`
- `.txt`, `.md`, `.rtf`

#### Зображення
- `.jpg`, `.jpeg`, `.png`, `.gif`, `.bmp`
- `.tiff`, `.webp`, `.svg`, `.ico`

#### Архіви
- `.zip`, `.rar`, `.7z`, `.tar`, `.gz`

#### Інші
- `.json`, `.xml`, `.yaml`, `.yml`
- `.html`, `.htm`

### Налаштування фільтрів

Фільтри можна редагувати у файлі `config.yaml`:

```yaml
# Виключення папок
exclude_dirs:
  - .git
  - node_modules
  - venv
  # ... додайте свої

# Виключення файлів (підтримує wildcard)
exclude_files:
  - "*.pyc"
  - "*.log"
  - Thumbs.db
  # ... додайте свої

# Включення розширень
include_extensions:
  - .pdf
  - .docx
  - .jpg
  # ... додайте свої

# Використовувати фільтр розширень (true/false)
use_extension_filter: true
```

### Відображення в Excel

**Важливо:** Службові файли **відображаються** в Excel з категорією `[службовий файл]`, але **не обробляються** (не хешуються, не перейменовуються).

**Приклад рядка в Excel:**

| Назва файлу       | Категорія         | Статус      |
|-------------------|-------------------|-------------|
| package-lock.json | [службовий файл]  | skipped     |
| node_modules/...  | [службовий файл]  | skipped     |
| Договір.pdf       | договір           | processed   |

---

## 📊 Формат Excel інвентаризації

Кожен запуск створює детальний Excel файл з **58 полями** у папці `runs/run_YYYYMMDD_HHMMSS/inventory.xlsx`.

### Структура файлу

#### Аркуш 1: "Inventory" - Повна інвентаризація

**Категорії полів:**

##### 1. Шляхи та назви (7 полів)
| Поле | Опис |
|------|------|
| `root` | Кореневий шлях сканування |
| `folder_old` | Стара папка |
| `path_old` | Старий повний шлях |
| `name_old` | Стара назва файлу |
| `name_new` | Нова назва (перейменована) |
| `folder_new` | Нова папка |
| `path_new` | Новий повний шлях |

##### 2. Сортування (4 поля)
| Поле | Опис |
|------|------|
| `sorted` | Чи файл відсортовано |
| `sort_strategy` | Стратегія сортування (by_category, by_date, by_type) |
| `sorted_subfolder` | Підпапка в відсортованій структурі |
| `path_final` | Фінальний шлях після сортування |

##### 3. Метадані файлу (6 полів)
| Поле | Опис |
|------|------|
| `ext` | Розширення (.pdf, .docx) |
| `mime` | MIME-тип (application/pdf) |
| `size_mb` | Розмір в МБ |
| `ctime` | Час створення |
| `mtime` | Час модифікації |
| `date_doc` | Дата документа (витягнута з назви) |

##### 4. Класифікація (4 поля)
| Поле | Опис |
|------|------|
| `category` | Категорія (договір, рахунок тощо) |
| `short_title` | Короткий заголовок |
| `version` | Версія (V01, V02) |
| `hash8` | Короткий хеш для унікальності |

##### 5. Дублікати (7 полів)
| Поле | Опис |
|------|------|
| `content_hash_sha256` | Повний SHA-256 хеш вмісту |
| `dup_type` | Тип дублікату (exact_dup, near_dup, unique) |
| `dup_group_id` | ID групи дублікатів |
| `dup_rank` | Ранг в групі (V1, V2, V3...) |
| `dup_master_path` | Шлях до мастер-файлу |
| `near_dup_score` | Оцінка схожості (0.0-1.0) |
| `lifecycle_state` | Стан (active, quarantined, deleted) |

##### 6. Життєвий цикл (1 поле)
| Поле | Опис |
|------|------|
| `deleted_ts` | Час видалення (якщо видалено) |

##### 7. Вилучення тексту (5 полів)
| Поле | Опис |
|------|------|
| `text_source` | Джерело тексту (embedded, ocr, filename, none) |
| `ocr_lang` | Мова OCR (ukr+eng) |
| `text_len` | Довжина витягнутого тексту |
| `extract_quality` | Якість вилучення (0.0-1.0) |
| `summary_200` | Короткий опис (200 символів) |

##### 8. LLM аналіз (3 поля)
| Поле | Опис |
|------|------|
| `llm_used` | Чи використано LLM |
| `llm_confidence` | Впевненість LLM (0.0-1.0) |
| `llm_keywords` | Ключові слова від LLM |

##### 9. Статус виконання (4 поля)
| Поле | Опис |
|------|------|
| `rename_status` | Статус перейменування (ok, error, skipped) |
| `error_message` | Повідомлення про помилку |
| `collision` | Чи була колізія імені |
| `duration_s` | Час обробки в секундах |

##### 10. Режим (1 поле)
| Поле | Опис |
|------|------|
| `mode` | Режим виконання (dry-run, commit) |

#### Аркуш 2: "Summary" - Підсумок сесії

| Метрика | Опис |
|---------|------|
| `run_id` | ID запуску (timestamp) |
| `files_total` | Загальна кількість файлів |
| `files_processed` | Оброблено файлів |
| `renamed_ok` | Успішно перейменовано |
| `renamed_failed` | Помилки перейменування |
| `duplicate_groups` | Груп дублікатів |
| `duplicate_files` | Файлів-дублікатів |
| `duration_total_s` | Загальний час (секунд) |
| `total_size_mb` | Загальний розмір (МБ) |

---

## 🤖 LLM інтеграція

### Підтримувані моделі

#### Claude (Anthropic)
- `claude-3-5-haiku-20241022` - швидка, дешева ($0.25/$1.25 за 1M токенів)
- `claude-3-5-sonnet-20241022` - найкраща для більшості ($3/$15 за 1M токенів)
- `claude-3-opus-20240229` - найпотужніша ($15/$75 за 1M токенів)

#### ChatGPT (OpenAI)
- `gpt-4o-mini` - швидка, дешева ($0.15/$0.60 за 1M токенів)
- `gpt-4o` - найкраща multimodal ($2.50/$10 за 1M токенів)
- `gpt-4-turbo` - попередня топова ($10/$30 за 1M токенів)

### Що робить LLM

1. **Класифікація документів**
   - Визначає категорію (договір, рахунок, акт тощо)
   - Витягує дату документа
   - Оцінює впевненість класифікації

2. **Анотація**
   - Створює короткий опис (200 символів)
   - Витягує ключові слова
   - Визначає тему документа

3. **Покращена класифікація**
   - Аналізує контекст документа
   - Розпізнає нестандартні формати
   - Покращує якість категоризації

### Приклад запиту до LLM

```
Проаналізуй наступний документ та визнач:
1. Категорію (договір/рахунок/акт/протокол/лист/наказ/звіт/інше)
2. Дату документа (YYYY-MM-DD)
3. Короткий опис (до 200 символів)

Текст документа:
"""
ДОГОВІР ПОСТАЧАННЯ №123
від 15 вересня 2024 року

Постачальник: ТОВ "Компанія А"
Покупець: ТОВ "Компанія Б"

Предмет договору: Постачання товарів...
"""

Відповідь у форматі JSON:
{
  "category": "...",
  "date": "...",
  "summary": "...",
  "confidence": 0.95
}
```

### Налаштування LLM

```yaml
# config.yaml
llm_enabled: true
llm_provider: "claude"  # або "chatgpt"
llm_api_key_claude: "sk-ant-..."
llm_api_key_openai: "sk-..."
llm_model: "claude-3-5-sonnet-20241022"
```

### Контроль витрат

Програма відстежує:
- Кількість запитів
- Кількість токенів (input/output)
- Приблизну вартість

**Приклад виводу:**
```
LLM Statistics:
  Requests: 100
  Tokens (input): 50,000
  Tokens (output): 10,000
  Estimated cost: $0.25
```

---

## ⚙️ Конфігурація

### Розташування конфігурації

Конфігурація зберігається у файлі `config.yaml` **в корені проекту** (поруч з `app/` та `run.bat`).

```
file_system/
├── app/
├── runs/
├── config.yaml  ← Тут
├── run.bat
└── README.md
```

### Повний приклад config.yaml

```yaml
# Версія конфігурації
version: "1.0"

# Папка для сканування
root: "C:/Documents"

# Шаблон перейменування
rename_template: "{yyyy}-{mm}-{dd}_{category}{ext}"

# Параметри короткого формату
use_short_format: true
use_short_date: false
max_filename_length: 20

# Категорії документів
category_map:
  - "договір"
  - "рахунок"
  - "акт"
  - "протокол"
  - "лист"
  - "наказ"
  - "звіт"
  - "кошторис"
  - "тендер"
  - "презентація"
  - "довідка"
  - "ТЗ"
  - "специфікація"
  - "інше"

# Дедуплікація
dedup:
  exact: true
  near: false
  near_threshold: 0.85

# Політика дублікатів
duplicates_policy:
  exact: "quarantine"  # або "delete_to_trash"

# Режим експорту
export_mode: "prompt"  # views_only/physical_sort/prompt

# Стратегії сортування
sorted_targets:
  - "by_category"
  - "by_date"
  - "by_type"

# Папка для відсортованих файлів
sorted_root: "_sorted"

# OCR
ocr_lang: "ukr+eng"

# LLM
llm_enabled: false
llm_provider: "none"  # claude/chatgpt/none
llm_api_key_claude: ""
llm_api_key_openai: ""
llm_model: ""

# Кількість потоків
threads: 0  # 0 = автоматично

# Фільтри сканування (НОВЕ)
exclude_dirs:
  - ".git"
  - ".svn"
  - "node_modules"
  - "venv"
  - "__pycache__"
  - ".idea"
  - ".vscode"
  - "dist"
  - "build"
  - "duplicates"
  - "runs"

exclude_files:
  - ".DS_Store"
  - "Thumbs.db"
  - "*.pyc"
  - "*.dll"
  - "*.exe"
  - "*.log"
  - "*.tmp"
  - "package-lock.json"
  - "yarn.lock"

include_extensions:
  - ".pdf"
  - ".doc"
  - ".docx"
  - ".xlsx"
  - ".txt"
  - ".jpg"
  - ".png"
  - ".zip"

use_extension_filter: true
```

---

## 🛠️ Troubleshooting

### Проблема: Програма не запускається

**Симптоми:**
```
ModuleNotFoundError: No module named 'app'
```

**Рішення:**
```bash
# Переконайтесь що ви в корені проекту
cd file_system

# Встановіть залежності
pip install -r requirements.txt

# Запустіть через модуль
python -m app.main
```

### Проблема: OCR не працює

**Симптоми:**
```
TesseractNotFoundError: tesseract is not installed
```

**Рішення:**
1. Встановіть Tesseract OCR (див. розділ "Встановлення")
2. Перевірте що Tesseract в PATH:
   ```bash
   tesseract --version
   ```
3. Вкажіть шлях до Tesseract вручну (Windows):
   ```python
   # В app/extract.py
   pytesseract.pytesseract.tesseract_cmd = r'C:\Program Files\Tesseract-OCR\tesseract.exe'
   ```

### Проблема: Таймер не оновлюється

**Симптоми:** Таймер "зависає" під час обробки

**Рішення:** Це виправлено в останній версії. Переконайтесь що у вас останній код:
```bash
git pull origin main
```

Таймер тепер оновлюється автоматично кожну секунду через `auto_refresh=True`.

### Проблема: Панелі різної ширини

**Симптоми:** Прогрес-бар і статистика мають різну ширину

**Рішення:** Виправлено. Всі панелі мають `expand=True` та `width=int(terminal_width * 0.95)`.

### Проблема: LLM не працює

**Симптоми:**
```
APIError: Invalid API key
```

**Рішення:**
1. Перевірте API ключ у `config.yaml`
2. Перевірте з'єднання через меню `[4] Налаштування`
3. Перевірте що у вас є кредити на рахунку Claude/OpenAI

### Проблема: Помилка Permission Denied

**Симптоми:**
```
PermissionError: [Errno 13] Permission denied
```

**Рішення:**
1. Запустіть програму від адміністратора (Windows)
2. Перевірте права доступу до папки
3. Закрийте файли які відкриті в інших програмах

### Проблема: Excel файл не відкривається

**Симптоми:** Excel повідомляє про пошкоджений файл

**Рішення:**
1. Переконайтесь що встановлено `openpyxl`:
   ```bash
   pip install openpyxl
   ```
2. Спробуйте відкрити через LibreOffice Calc
3. Перевірте що немає спецсимволів у назвах файлів

---

## ❓ FAQ

### Q: Як додати нову категорію документів?

**A:** Відредагуйте `config.yaml`:

```yaml
category_map:
  - "договір"
  - "рахунок"
  # ... інші
  - "моя_нова_категорія"  # Додайте тут
```

### Q: Чи можна обробити 100,000+ файлів?

**A:** Так! Програма оптимізована для великих обсягів:
- Прогресивне сканування (не завантажує всі файли в пам'ять)
- Фільтрація службових файлів (зменшує навантаження)
- Обробка помилок (не переривається при помилці)

Рекомендації:
- Вимкніть LLM для великих обсягів (дорого)
- Вимкніть OCR якщо не потрібно
- Використайте потужний комп'ютер

### Q: Чи можна відмінити перейменування?

**A:** Ні, операція `[2] Застосувати перейменування` **необоротна**.

Рекомендації:
- Завжди робіть `[1] Швидкий аналіз (dry-run)` спочатку
- Перевіряйте попередній перегляд
- Робіть резервну копію перед застосуванням

### Q: Де зберігається історія запусків?

**A:** У папці `runs/` в корені проекту:

```
runs/
├── run_20241109_143022/
│   ├── config.yaml
│   ├── inventory.xlsx
│   └── progress.json
├── run_20241109_150015/
│   └── ...
└── run_20241109_153045/
    └── ...
```

### Q: Як додати свій фільтр файлів?

**A:** Відредагуйте `config.yaml`:

```yaml
exclude_dirs:
  - "my_custom_folder"  # Виключити папку

exclude_files:
  - "*.backup"          # Виключити за патерном
  - "my_file.txt"       # Виключити конкретний файл

include_extensions:
  - ".myext"            # Включити нове розширення
```

### Q: Чи можна використовувати без інтернету?

**A:** Так, але з обмеженнями:
- ✅ Сканування, хешування, перейменування - працює
- ✅ OCR (якщо Tesseract встановлено локально) - працює
- ❌ LLM класифікація - не працює (потребує API)

### Q: Скільки коштує LLM?

**A:** Залежить від моделі та кількості файлів.

Приклад для 1000 файлів (середній текст 500 слів):
- `claude-3-5-haiku`: $0.25 - $0.50
- `claude-3-5-sonnet`: $3 - $6
- `gpt-4o-mini`: $0.15 - $0.30

Рекомендація: почніть з `haiku` або `gpt-4o-mini`.

### Q: Як видалити всі дублікати автоматично?

**A:**
```
Головне меню → [7] Робота з дублікатами → [3] Видалити всі дублікати (в кошик)
```

Дублікати видаляються в кошик - можна відновити.

---

## 📄 Ліцензія

MIT License - використовуйте вільно для особистих та комерційних проектів.

---

## 🤝 Внесок у проект

Вітаються pull requests! Для великих змін спочатку відкрийте issue для обговорення.

---

## 📮 Контакти

Якщо у вас є питання або пропозиції - створіть issue на GitHub.

---

**Версія документації:** 2.0 (Листопад 2024)
**Останнє оновлення:** 09.11.2024
