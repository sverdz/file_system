# File Inventory Tool - Інструмент інвентаризації та перейменування файлів

Повнофункціональна TUI (Text User Interface) система для автоматизованої інвентаризації, класифікації, перейменування та організації файлів з підтримкою LLM (Claude/ChatGPT), OCR та дедуплікації.

---

## 📋 Зміст

- [Ключові можливості](#-ключові-можливості)
- [Архітектура системи](#-архітектура-системи)
- [Логіка перейменування (НОВИНКА)](#-логіка-перейменування-новинка)
- [Структура сесій](#-структура-сесій)
- [TUI інтерфейс](#-tui-інтерфейс)
- [LLM інтеграція](#-llm-інтеграція)
- [Встановлення](#-встановлення)
- [Використання](#-використання)
- [Конфігурація](#-конфігурація)
- [Формат інвентаризаційних файлів](#-формат-інвентаризаційних-файлів)
- [Тестування](#-тестування)
- [Журнал змін](#-журнал-змін)

---

## 🚀 Ключові можливості

### 1. **Жорстке обмеження довжини імен файлів (20 символів)**
- Автоматичне формування імен за шаблоном: `{ДАТА}_{КЛАСИФІКАЦІЯ}_{СУФІКС}`
- Гарантовано коректні імена для всіх файлових систем
- Автоматичне усічення класифікації при перевищенні ліміту
- Короткі унікальні суфікси: `a`, `b`, `c`... `z`, потім `1`, `2`, `3`...

### 2. **Попередній перегляд перейменування**
- Інтерактивна таблиця з маппінгом `старе ім'я → нове ім'я`
- Контроль довжини кожного імені в реальному часі
- Попередження про колізії та перевищення лімітів
- Підтвердження перед фактичним застосуванням змін

### 3. **Повна інвентаризація та класифікація**
- Автоматична класифікація документів (договір, рахунок, акт, протокол, тощо)
- Вилучення тексту з PDF, DOCX, зображень (OCR)
- Виявлення точних дублікатів (SHA256)
- Експорт у багатолистовий Excel з категоризацією

### 4. **Інтеграція з LLM**
- Підтримка Claude (Anthropic) та ChatGPT (OpenAI)
- Автоматична анотація та класифікація документів
- Інтерактивні запити до LLM для конкретних файлів
- Відстеження токенів та статистики використання

### 5. **Організація та сортування**
- Автоматичне сортування: по категоріях, датах, типах файлів
- Карантин або видалення дублікатів
- Збереження повної історії операцій

---

## 🏗️ Архітектура системи

```
file_system/
├── app/
│   ├── classify.py       # Класифікація документів (LLM + heuristics)
│   ├── config.py         # Конфігурація та параметри
│   ├── dedup.py          # Виявлення дублікатів (exact/near)
│   ├── extract.py        # Вилучення тексту (PDF, DOCX, OCR)
│   ├── inventory.py      # Експорт інвентаризації в Excel
│   ├── llm_client.py     # Клієнт для Claude/ChatGPT
│   ├── main.py           # Головний TUI інтерфейс
│   ├── progress.py       # Прогрес-бар та трекінг етапів
│   ├── rename.py         # ★ Логіка перейменування (ОНОВЛЕНО)
│   ├── scan.py           # Сканування директорій та метадані
│   └── sortout.py        # Сортування та організація файлів
├── runs/                 # Історія всіх сесій
│   ├── config.yaml       # Глобальна конфігурація
│   └── YYYYMMDDTHHMMSS/  # Окрема папка для кожної сесії
│       ├── config.yaml   # Знімок конфігурації сесії
│       ├── inventory.xlsx # Інвентаризаційний Excel-файл
│       ├── progress.json # Прогрес виконання
│       └── logs/         # Детальні логи операцій
├── test_rename_logic.py  # Тести логіки перейменування
└── requirements.txt      # Залежності Python
```

---

## ⚡ Логіка перейменування (НОВИНКА)

### Структура імені файлу

Кожне нове ім'я файлу формується за єдиним шаблоном:

```
{ДАТА}_{КЛАСИФІКАЦІЯ}_{СУФІКС}{РОЗШИРЕННЯ}
│      │               │        │
│      │               │        └─ Оригінальне розширення (.pdf, .docx, ...)
│      │               └────────── Унікальний суфікс (a-z, потім 1-99)
│      └────────────────────────── Скорочена класифікація (автоматично усічена)
└───────────────────────────────── Дата (YYYYMMDD або YYMMDD)
```

**Максимум 20 символів БЕЗ розширення.**

### Приклади

| Оригінальне ім'я | Нове ім'я | Довжина | Опис |
|-----------------|-----------|---------|------|
| `Договір на постачання 2024.pdf` | `20241107_dogovir_a.pdf` | 18 | Договір, перший файл дня |
| `Рахунок-фактура №123.xlsx` | `20241107_rakhunok_b.xlsx` | 19 | Рахунок, другий файл дня |
| `Акт виконаних робіт.docx` | `20241107_akt_c.docx` | 16 | Акт, третій файл дня |
| `Тендерна пропозиція (дуже довга назва).pdf` | `20241107_tender_d.pdf` | 17 | Автоматично усічено |
| `Document-25.pdf` (колізія) | `20241107_inshe_26.pdf` | 18 | Суфікс 26 = цифра "1" |

### Логіка усічення

Пріоритети при досягненні ліміту 20 символів:

1. **Дата** - зберігається повністю (8 або 6 символів)
2. **Суфікс** - зберігається повністю (1-2 символи)
3. **Класифікація** - автоматично усічена до доступного простору

**Формула:**
```
max_category_length = 20 - date_length - 2 (underscores) - suffix_length
```

Для `YYYYMMDD` (8 символів) + суфікс `a` (1 символ):
```
max_category = 20 - 8 - 2 - 1 = 9 символів
```

### Безпечні символи

Тільки: `A-Z`, `a-z`, `0-9`, `_`, `-`

Усі українські та спеціальні символи транслітеруються:
- `договір` → `dogovir`
- `рахунок-фактура` → `rakhunok_faktura`
- `звіт №123` → `zvitNo123`

### Обробка колізій

При конфлікті імен автоматично додається наступний суфікс:

```
20241107_dogovir_a.pdf  ← перший файл
20241107_dogovir_b.pdf  ← другий файл з такою ж датою та категорією
20241107_dogovir_c.pdf  ← третій файл
...
20241107_dogovir_z.pdf  ← 26-й файл
20241107_dogovir_1.pdf  ← 27-й файл (перехід на числа)
20241107_dogovir_2.pdf  ← 28-й файл
```

### Попередній перегляд

Перед застосуванням перейменування система показує інтерактивну таблицю:

```
╔═══════════════════════════════════════════════════════════════╗
║       ПОПЕРЕДНІЙ ПЕРЕГЛЯД ПЕРЕЙМЕНУВАННЯ ФАЙЛІВ              ║
╚═══════════════════════════════════════════════════════════════╝

┏━━━━━┳━━━━━━━━━━━━━━━━━┳━━━┳━━━━━━━━━━━━━━━━━┳━━━━━━━━┳━━━━━━━━━┓
┃ №   ┃ Старе ім'я      ┃ → ┃ Нове ім'я       ┃ Довжина┃ Колізія ┃
┡━━━━━╇━━━━━━━━━━━━━━━━━╇━━━╇━━━━━━━━━━━━━━━━━╇━━━━━━━━╇━━━━━━━━━┩
│ 1   │ Договір 2024.pdf│ → │ 20241107_dogovi…│   18   │         │
│ 2   │ Рахунок.xlsx    │ → │ 20241107_rakhun…│   19   │    ✓    │
└─────┴─────────────────┴───┴─────────────────┴────────┴─────────┘

Підсумок:
  • Всього файлів для перейменування: 245
  • Файлів з колізіями (додано суфікс): 12

Застосувати перейменування?
Введіть 'y' або 'yes' для підтвердження: _
```

---

## 📁 Структура сесій

Кожен запуск створює окрему підпапку у `runs/` з ізольованою історією:

```
runs/
├── 20241107T143052/           # Сесія SCAN (швидкий аналіз)
│   ├── config.yaml            # Знімок конфігурації
│   ├── inventory.xlsx         # Інвентаризація з 5 листами
│   │   ├── inventory          # Повна таблиця всіх файлів
│   │   ├── by_category        # Сортування по категоріях
│   │   ├── by_date            # Сортування по датах
│   │   ├── by_type            # Сортування по типах файлів
│   │   └── run_summary        # Статистика сесії
│   └── progress.json          # Трекінг прогресу
│
├── 20241107T145230/           # Сесія RENAME (застосування змін)
│   ├── config.yaml
│   ├── inventory.xlsx
│   └── progress.json
│
└── 20241107T150815/           # Сесія SORT (організація файлів)
    ├── config.yaml
    ├── inventory.xlsx
    └── progress.json
```

**Назва папки:** `YYYY-MM-DD_HH-mm-ss_OPERATION`
- `OPERATION` може бути: `SCAN`, `RENAME`, `SORT`, або інші

**Ключові особливості:**
- Кожна сесія повністю ізольована
- Попередні результати ніколи не перезаписуються
- Хронологічний трекінг всіх дій для аудиту

---

## 🖥️ TUI інтерфейс

### Прогрес-бар (верхній статус-бар)

```
┌─────────────────────────────────────────────────────────────┐
│ ⠋ Вилучення тексту document.pdf (156/245) ······ 64%       │
│ • 156/245 • Пройшло: 00:02:15 • Залишилось: ~00:01:30      │
└─────────────────────────────────────────────────────────────┘
```

**Етапи обробки:**
1. 🔍 **Сканування файлів** - пошук та індексація всіх файлів
2. 🔁 **Пошук дублікатів** - виявлення exact duplicates (SHA256)
3. 📄 **Вилучення тексту** - парсинг PDF/DOCX, OCR для зображень
4. 🏷️ **Класифікація** - визначення категорій (LLM або heuristics)
5. ✏️ **Перейменування** - застосування нових імен з обмеженням 20 символів
6. 📊 **Створення звіту** - експорт інвентаризації в Excel

### Формат відображення поточного файлу

```
Назва файлу | Дублікати | Класифікація | LLM
─────────────────────────────────────────────────
document.pdf | 2 знайдено | договір | 1 запит / 1 відповідь
invoice.xlsx | унікальний | рахунок | 0 запитів
```

**Після завершення обробки файлу панель очищується та переходить до наступного.**

### Фінальний підсумок

```
╔═══════════════════════════════════════════════════════════╗
║                 ПІДСУМОК СЕСІЇ                            ║
╚═══════════════════════════════════════════════════════════╝

📊 Статистика обробки:
  • Всього просканованих файлів: 245
  • Перейменовано файлів: 230
  • Пропущено (дублікати): 15

🔁 Дублікати:
  • Виявлено груп дублікатів: 7
  • Файлів у дублікатах: 15

🤖 LLM використання:
  • Запитів до LLM: 230
  • Отримано відповідей: 228
  • Надіслано токенів: 45,600
  • Отримано токенів: 12,300

💾 Інвентаризація збережена:
  runs/20241107T150815/inventory.xlsx
```

---

## 🤖 LLM інтеграція

### Налаштування

1. Виберіть провайдера: `Claude` або `ChatGPT`
2. Введіть API ключ
3. Оберіть модель:
   - Claude: `claude-3-5-sonnet-20241022`, `claude-3-opus-20240229`, `claude-3-haiku-20240307`
   - ChatGPT: `gpt-4o`, `gpt-4-turbo`, `gpt-3.5-turbo`

### Обмеження

**Запит:**
- Максимум **1000 символів**
- Контроль довжини до відправлення
- Відображення залишку символів

**Відповідь:**
- Максимум **500 символів** у TUI
- Повна відповідь логується у файл сесії

### Контекст

Кожен LLM-запит асоціюється з **активним файлом**, який наразі відображається на екрані.

**Що передається у контекст:**
- Назва файлу
- Вилучений текст (перші 2000 символів)
- Поточна класифікація
- Дата документа (якщо визначена)

### Типові запити

```
"Яка категорія цього документа?"
"Витягни дату та номер договору"
"Запропонуй коротку назву файлу (до 15 символів)"
"Визнач тип документа: договір, рахунок, акт, чи інше"
```

---

## 📦 Встановлення

### Вимоги

- Python 3.10+
- Tesseract OCR (для розпізнавання зображень)
- Poppler (для PDF → зображення)

### Крок 1: Клонування репозиторію

```bash
git clone https://github.com/sverdz/file_system.git
cd file_system
```

### Крок 2: Встановлення залежностей

```bash
pip install -r requirements.txt
```

### Крок 3: Встановлення системних залежностей (Linux/macOS)

```bash
# Ubuntu/Debian
sudo apt install tesseract-ocr tesseract-ocr-ukr tesseract-ocr-eng poppler-utils

# macOS
brew install tesseract tesseract-lang poppler
```

### Крок 4: Windows (швидкий старт)

```cmd
# Перейти до директорії
cd /d "C:\Users\<USERNAME>\...\file_system"

# Запустити через batch-файл
run.bat
```

`run.bat` автоматично створить venv, встановить залежності та запустить програму.

---

## 🎯 Використання

### Запуск інтерфейсу

```bash
python app/main.py
```

### Головне меню

```
╔═══════════════════════════════════════════════════════════╗
║         File Inventory Tool - Головне меню                ║
╚═══════════════════════════════════════════════════════════╝

1. Швидкий аналіз (dry-run)
   └─ Перегляд без застосування змін

2. Застосувати перейменування (commit)
   └─ Фактичне перейменування + опції

3. Переглянути підсумок
   └─ Останній запуск та статистика

4. Налаштування
   └─ LLM, OCR, шаблони перейменування

5. Відновити незавершений запуск
   └─ (не реалізовано)

6. Сортування та подання
   └─ Організація файлів по категоріях/датах

7. Перевірити залежності
   └─ Tesseract, Poppler, Python пакети

8. Вихід

Оберіть опцію (1-8): _
```

### Типовий робочий процес

1. **Швидкий аналіз** (опція 1)
   - Сканування файлів
   - Виявлення дублікатів
   - Класифікація
   - Попередній перегляд перейменування
   - Експорт звіту

2. **Перегляд результатів** (опція 3)
   - Відкрити `runs/<TIMESTAMP>/inventory.xlsx`
   - Переглянути листи: `inventory`, `by_category`, `by_date`

3. **Застосувати зміни** (опція 2)
   - Фактичне перейменування файлів
   - Попередній перегляд та підтвердження
   - Опціонально: видалення дублікатів

4. **Сортування** (опція 6)
   - Організація файлів по категоріях: `_sorted/by_category/договір/`
   - По датах: `_sorted/by_date/2024/2024-11-07/`
   - По типах: `_sorted/by_type/pdf/`

---

## ⚙️ Конфігурація

Файл: `runs/config.yaml`

```yaml
version: "1.0"
root: "/шлях/до/файлів"

# Логіка перейменування (НОВИНКА)
use_short_format: true            # Використовувати короткий формат (20 символів)
use_short_date: false             # YYMMDD замість YYYYMMDD
max_filename_length: 20           # Максимальна довжина без розширення

# Старий шаблон (якщо use_short_format=false)
rename_template: "{yyyy}-{mm}-{dd}_{category}{ext}"

# Категорії документів
category_map:
  - "договір"
  - "рахунок"
  - "акт"
  - "протокол"
  - "лист"
  - "наказ"
  - "звіт"
  - "кошторис"
  - "тендер"
  - "презентація"
  - "довідка"
  - "ТЗ"
  - "специфікація"
  - "інше"

# Дублікати
dedup:
  exact: true                     # Виявляти точні дублікати
  near: false                     # Near-duplicates (не реалізовано)
  near_threshold: 0.85

duplicates_policy:
  exact: "quarantine"             # quarantine | delete_to_trash
  near: "quarantine"

# Сортування
export_mode: "prompt"             # prompt | views_only | physical_sort
sorted_targets:
  - "by_category"
  - "by_date"
  - "by_type"
sorted_root: "_sorted"

# OCR
ocr_lang: "ukr+eng"               # Мови Tesseract

# LLM
llm_enabled: true
llm_provider: "claude"            # claude | chatgpt | none
llm_api_key_claude: "sk-ant-..."
llm_api_key_openai: ""
llm_model: "claude-3-5-sonnet-20241022"

# Продуктивність
threads: 0                        # 0 = auto (кількість CPU)
```

---

## 📊 Формат інвентаризаційних файлів

### Excel структура

Файл: `runs/<TIMESTAMP>/inventory.xlsx`

**5 листів:**

#### 1. `inventory` - Повна таблиця (56 колонок)

| Поле | Опис |
|------|------|
| `path_old` | Оригінальний шлях |
| `path_new` | Новий шлях після перейменування |
| `name_old` | Стара назва файлу |
| `name_new` | Нова назва файлу |
| `category` | Класифікація (договір, рахунок, ...) |
| `date_doc` | Дата документа (ISO 8601) |
| `size_mb` | Розмір у МБ |
| `hash8` | Перші 8 символів SHA256 |
| `dup_type` | `exact_dup` | `unique` |
| `dup_group_id` | ID групи дублікатів |
| `rename_status` | `success` | `failed` | `skipped` |
| `collision` | `True` якщо була колізія імен |
| `text_len` | Довжина вилученого тексту |
| `extract_quality` | 0.0-1.0 (якість вилучення) |
| `llm_used` | Чи використовувався LLM |
| `summary_200` | Короткий опис файлу |

#### 2. `by_category` - Сортування по категоріях

Групування всіх файлів по полю `category`.

#### 3. `by_date` - Сортування по датах

Групування по `date_doc`.

#### 4. `by_type` - Сортування по типах файлів

Групування по `ext` (розширення).

#### 5. `run_summary` - Підсумок сесії

| Метрика | Значення |
|---------|----------|
| `run_id` | `20241107T150815` |
| `start_time` | `2024-11-07 15:08:15` |
| `total_files` | `245` |
| `renamed_files` | `230` |
| `duplicate_groups` | `7` |
| `llm_requests` | `230` |
| `llm_responses` | `228` |
| `tokens_sent` | `45600` |
| `tokens_received` | `12300` |

---

## 🧪 Тестування

### Запуск тестів логіки перейменування

```bash
python test_rename_logic.py
```

**Що тестується:**
- Транслітерація українських символів
- Генерація коротких суфіксів (a-z, 1-99)
- Усічення імен до 20 символів
- Обробка граничних випадків

**Приклад виводу:**
```
╔════════════════════════════════════════════════════════════╗
║  Тестування нової логіки перейменування (20 символів)     ║
╚════════════════════════════════════════════════════════════╝

=== Тест sanitize_filename_component() ===
  'договір' → 'dogovir'
  'рахунок-фактура' → 'rakhunok_faktura'
  ✓ Всі тести пройдено

=== Тест generate_short_suffix() ===
  Індекс  0 → 'a'
  Індекс 25 → 'z'
  Індекс 26 → '1'
  ✓ Всі тести пройдено

=== Тест build_short_filename() ===
  Результат: 20241107_dogovir_a.pdf
  Довжина без розширення: 18
  ✓ Довжина 18 <= 20

============================================================
✓ ВСІ ТЕСТИ УСПІШНО ПРОЙДЕНО!
============================================================
```

---

## 📝 Журнал змін

### Версія 2.0 (2024-11-07) - Жорстке обмеження імен файлів

**Нові функції:**
- `app/rename.py`:
  - `sanitize_filename_component()` - транслітерація та очищення
  - `generate_short_suffix()` - короткі суфікси (a-z, 1-99)
  - `build_short_filename()` - обмеження 20 символів
  - Оновлено `plan_renames()` з параметрами `use_short_format` та `use_short_date`

- `app/main.py`:
  - `show_rename_preview()` - попередній перегляд у вигляді таблиці
  - Інтеграція підтвердження перед застосуванням

- `app/config.py`:
  - `use_short_format: bool = True`
  - `use_short_date: bool = False`
  - `max_filename_length: int = 20`

**Ключові переваги:**
- Гарантовано коректні імена для всіх файлових систем
- Передбачуваність та контрольованість
- Відсутність хешів та некерованих суфіксів
- Автоматичне логування в інвентаризаційних файлах

### Версія 1.0 (попередня)

- Базова інвентаризація та класифікація
- LLM інтеграція (Claude/ChatGPT)
- OCR підтримка
- Дедуплікація файлів
- Сортування та організація

---

## 🔗 Посилання

- **Репозиторій:** https://github.com/sverdz/file_system
- **Гілка:** `claude/file-rename-formatting-logic-011CUsbsveaiMLaAXT1vEpFj`

---

## 📄 Ліцензія

MIT License

---

## 👥 Автори

- **sverdz** - Основний розробник
- **Claude (Anthropic)** - Асистент розробки

---

## 🙏 Подяки

- Anthropic за Claude API
- OpenAI за ChatGPT API
- Tesseract OCR проєкт
- Poppler PDF утиліти
- Спільнота Python

---

**Останнє оновлення:** 2024-11-07
